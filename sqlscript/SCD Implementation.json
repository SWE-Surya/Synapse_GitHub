{
	"name": "SCD Implementation",
	"properties": {
		"content": {
			"query": "create table stg\n(\n    id int,\n    name varchar(20),\n    country varchar(30),\n    DimensionCheckSum int default -1\n\n)\nwith\n(\n    DISTRIBUTION = HASH ( [id] ),\n\tCLUSTERED COLUMNSTORE INDEX\n)\n\ncreate table scd2\n(\n    id int,\n    name varchar(20),\n    country varchar(30),\n    DimensionCheckSum int default -1,\n    ValidFrom datetime,\n    ValidTo date default '12/31/9999',\n    CurrentRecord int default 1\n\n)\nwith\n(\n    DISTRIBUTION = HASH ( [id] ),\n\tCLUSTERED COLUMNSTORE INDEX\n)\n\ninsert into stg\nvalues (1,'abc','australia',-1)\ninsert into stg\nvalues (2,'bcd','US',-1)\n\n\nSELECT * FROM stg;\n\n\n\nSELECT * FROM stg where DimensionCheckSum=410179;\n\n--Updates the Checksum of all the columns in a CheckSum field of Staging Table\nUPDATE stg SET DimensionCheckSum=\nBINARY_CHECKSUM\n(\n    [id],\n    [name],\n    [country]\n);\n\n\n\n--Insert only those records which have an update by comparing Checksum against the record which was last active\nINSERT INTO scd2\n    SELECT \n    stg_table.[id],\n    stg_table.[name],\n    stg_table.[country],\n    stg_table.[DimensionCheckSum],\n    GETDATE(), \n    '12/31/9999', \n    1\n    FROM stg stg_table\n    JOIN scd2 main_table \n    ON stg_table.id = main_table.id\n    WHERE (stg_table.DimensionCheckSum <> main_table.DimensionCheckSum) AND main_table.CurrentRecord<>0;\n\n\n\nSELECT * FROM stg;\nSELECT * FROM scd2;\n\nMERGE scd2 AS target\nUSING stg AS source \nON target.Id = source.Id\nWHEN MATCHED and target.DimensionCheckSum <> source.DimensionCheckSum and target.CurrentRecord=1 THEN UPDATE SET \n    ValidTo=getdate(),\n    CurrentRecord=0\nWHEN NOT MATCHED BY TARGET THEN  \n    INSERT \n    (\n    [Id],\n    [name],\n    [country],\n    [DimensionCheckSum],\n    [ValidFrom]\n    )\n    VALUES \n    (\n    source.[id],\n    source.[name],\n    source.[country],\n    source.[DimensionCheckSum],\n    getdate()\n);\n\n\nupdate stg\nset country='india'\nwhere id = 1\n\n----Now rerun the checksum , insert and merge query given above.\n\n\n\n\nSELECT * from stg;\n    \nSELECT * from scd2;\n\n\ndrop TABLE scd2;\n\ntruncate table scd2;\n\n\n\n---------My Implementation----------\n\ncreate table stg\n(\n    id int,\n    name varchar(20),\n    country varchar(30),\n    city varchar(20)\n)with\n(\n    DISTRIBUTION = HASH ( [id] ),\n\tCLUSTERED COLUMNSTORE INDEX\n)\n\n\nCREATE table scd2(\n    scd2_sk int IDENTITY,\n    id int,\n    name varchar(20),\n    country varchar(30),\n    city varchar(20),\n    ValidFrom datetime,\n    ValidTo date default '12/31/9999',\n    CurrentRecord int default 1\n)\nwith\n(\n    DISTRIBUTION = HASH ( [id] ),\n\tCLUSTERED COLUMNSTORE INDEX\n)\n\n\n\n\ninsert into stg\nvalues (1,'abc','australia','sydney')\ninsert into stg\nvalues (2,'bcd','US','Newyork')\n\n\nSELECT * FROM STG;\nSELECT * FROM scd2;\n\n\n\n\nINSERT INTO scd2\n    SELECT \n    stg_table.[id],\n    stg_table.[name],\n    stg_table.[country],\n    stg_table.[city],\n    GETDATE(), \n    '12/31/9999', \n    1\n    FROM stg stg_table\n    JOIN scd2 main_table \n    ON stg_table.id = main_table.id\n    WHERE (stg_table.name <> main_table.name OR stg_table.country <> main_table.country) AND main_table.CurrentRecord<>0;\n\n\n\n-----------------------\nMERGE scd2 AS target\nUSING stg AS source \nON target.Id = source.Id\nWHEN MATCHED and (target.name <> source.name or target.country <> source.country) and target.CurrentRecord=1 THEN UPDATE SET \n    ValidTo=getdate(),\n    CurrentRecord=0;\n\n\n-- WHEN NOT MATCHED BY target THEN  \n--     INSERT \n--     (\n--     [Id],\n--     [name],\n--     [country],\n--     [city],\n--     [ValidFrom]\n--     )\n--     VALUES \n--     (\n--     source.[id],\n--     source.[name],\n--     source.[country],\n--     source.[city],\n--     getdate()\n-- )\n\n\nSELECT * from scd2;\n\nINSERT INTO scd2(\n    [Id],\n    [name],\n    [country],\n    [city],\n    [ValidFrom]\n    )\nSELECT \n    \n    source.[id],\n    source.[name],\n    source.[country],\n    source.[city],\n    getdate()\nFROM stg source WHERE source.id not in(SELECT id from scd2);\n\nSELECT * from stg;\n\nSELECT * from scd2;\n\n\n\nupdate stg\nset country='india'\nwhere id = 1;\n\nSELECT * FROM SCD2;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "DEV",
				"poolName": "DEV"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}