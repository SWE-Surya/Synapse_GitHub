{
	"name": "SCD_Implementation_2",
	"properties": {
		"content": {
			"query": "create table stg3\n(\n    id int,\n    name varchar(20),\n    country varchar(30),\n    city varchar(20)\n)\n\n\nCREATE table scd3(\n    scd2_sk int IDENTITY,\n    id int,\n    name varchar(20),\n    country varchar(30),\n    city varchar(20),\n    ValidFrom datetime,\n    ValidTo date default '12/31/9999',\n    CurrentRecord int default 1\n)\n\n\n\n\nSELECT * FROM stg3;\n\nSELECT * FROM scd3;\n\n\n\ninsert into stg3\nvalues (1,'abc','australia','sydney')\ninsert into stg3\nvalues (2,'bcd','US','Newyork')\ninsert into stg3\nvalues (3,'kef','Netherland','Norww')\n\n\ninsert into stg3\nvalues (4,'vfs','vdfs','gssw')\n\n-- DELETE FROM stg3 WHERE country='vdfs';\n\n\n\n\n-----------SCD IMPLEMENTATION-------\n\n-- insert that record which has been modified in stage\nINSERT INTO scd3\n    SELECT \n    stg_table.[id],\n    stg_table.[name],\n    stg_table.[country],\n    stg_table.[city],\n    GETDATE(), \n    '12/31/9999', \n    1\n    FROM stg3 stg_table\n    JOIN scd3 main_table \n    ON stg_table.id = main_table.id\n    WHERE (stg_table.name <> main_table.name OR stg_table.country <> main_table.country) AND main_table.CurrentRecord<>0;\n\n\n\n--- when actual update happned to the previous record, THE OLD RECORD WILL HAVE BECAME 0 AND 999 CHANGE TO CURR DATE\nMERGE scd3 AS target\nUSING stg3 AS source \nON target.Id = source.Id\nWHEN MATCHED and (target.name <> source.name or target.country <> source.country) and target.CurrentRecord=1 THEN UPDATE SET \n    ValidTo=getdate(),\n    CurrentRecord=0;\n\n\nINSERT INTO scd3(\n    [Id],\n    [name],\n    [country],\n    [city],\n    [ValidFrom]\n    )\nSELECT \n    \n    source.[id],\n    source.[name],\n    source.[country],\n    source.[city],\n    getdate()\nFROM stg3 source WHERE source.id not in(SELECT id from scd3);\n\n\n\n\n\n\n-----------IMPLEMENTATION END -------\n\n\n\n\n\nSELECT * FROM STG3;\n\nSELECT * FROM SCD3;\n\n\n-- UPDATION HAPPEN FROM STG SIDE, Australia becomes India\n\nupdate stg3\nset country='India'\nwhere id = 1;\n\n-- UPDATION HAPPEN FROM STG SIDE, India becomes India\nupdate stg3\nset country='UK'\nwhere id = 1;\n\n\nupdate stg3\nset city='aabara ka daabra'\nwhere id = 3;\n\n\n\n-- TRUNCATE table stg3;\n-- truncate table scd3;\n\n\n\nSELECT * FROM STG3;\n\nSELECT * FROM SCD3;\n\n\nSELECT * from stg3 src right join scd3 tar on src.id=tar.id\nwhere tar.id not in (select id from stg3);\n\nUPDATE scd3\nset ValidTo=getdate(),\n    CurrentRecord=0\nfrom STG3 src right join scd3 tar on src.id=tar.id where tar.id not in (select id from stg3) and tar.CurrentRecord<>0;\n\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "DEV",
				"poolName": "DEV"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}